<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gjenstående Tapping</title>

<style>
body {
  margin: 0;
  padding: 16px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f6f7;
  color: #222;
}

h1 {
  margin-top: 0;
  font-size: 22px;
}

.section {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

label {
  font-size: 14px;
  margin-bottom: 4px;
  display: block;
}

input {
  width: 100%;
  padding: 10px;
  font-size: 18px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.input-row {
  display: flex;
  gap: 6px;
  align-items: center;
}

.modning-input {
  flex: 1;
}

.minus-btn {
  width: 42px;
  height: 42px;
  font-size: 24px;
  border-radius: 8px;
  border: none;
  background: #ddd;
  cursor: pointer;
}

.add-btn {
  width: 100%;
  margin-top: 10px;
  padding: 10px;
  font-size: 20px;
  border-radius: 10px;
  border: none;
  background: #e0e0e0;
  cursor: pointer;
}

.result {
  font-size: 32px;
  font-weight: bold;
  text-align: center;
}

.reset-btn {
  margin-top: 10px;
  width: 100%;
  padding: 12px;
  font-size: 18px;
  border-radius: 10px;
  border: none;
  background: #d9534f;
  color: #fff;
  cursor: pointer;
}

.tank-area {
  display: flex;
  gap: 10px;
  height: 220px;
}

.tank {
  flex: 1;
  border: 2px solid #888;
  border-radius: 12px;
  position: relative;
  background: #fff;
  overflow: hidden;
}

.fill {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: linear-gradient(#4caf50, #81c784);
  transition: height 0.4s linear;
}

.tank-label {
  position: absolute;
  top: 6px;
  width: 100%;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
}

.tank-liters {
  position: absolute;
  bottom: 6px;
  width: 100%;
  text-align: center;
  font-size: 14px;
}
</style>
</head>

<body>

<h1>Gjenstående Tapping</h1>

<div class="section">
  <label>Steriltank (liter)</label>
  <input id="sterileInput" inputmode="numeric" pattern="[0-9]*">

  <button class="add-btn" onclick="addModning()">＋ Legg til Modningstank</button>

  <div id="modningInputs"></div>

  <label>Liter per time (per maskin)</label>
  <input id="lph" inputmode="numeric" pattern="[0-9]*">

  <label>Antall Tappemaskiner</label>
  <input id="machines" inputmode="numeric" pattern="[0-9]*">
</div>

<div class="section">
  <div class="result" id="timeResult">ca. 0 timer</div>
  <button class="reset-btn" onclick="resetAll()">Nullstill</button>
</div>

<div class="section">
  <div class="tank-area" id="tankArea"></div>
</div>

<script>
const MAX_TANKS = 5;

let state = {
  sterile: 0,
  modning: [],
  lph: 0,
  machines: 0,
  activeModning: 0,
  lastTime: Date.now()
};

function save() {
  localStorage.setItem("tappingState", JSON.stringify(state));
}

function load() {
  const s = localStorage.getItem("tappingState");
  if (s) state = JSON.parse(s);
}

function addModning() {
  if (state.modning.length >= MAX_TANKS - 1) return;
  state.modning.push(0);
  save();
  renderInputs();
  renderTanks();

  setTimeout(() => {
    const inputs = document.querySelectorAll(".modning-input");
    inputs[inputs.length - 1]?.focus();
  }, 50);
}

function removeModning(i) {
  state.modning.splice(i, 1);
  if (state.activeModning > i) state.activeModning--;
  save();
  renderInputs();
  renderTanks();
}

function renderInputs() {
  const c = document.getElementById("modningInputs");
  c.innerHTML = "";
  state.modning.forEach((v, i) => {
    const div = document.createElement("div");
    div.innerHTML = `
      <label>Modningstank (liter)</label>
      <div class="input-row">
        <input class="modning-input" inputmode="numeric" pattern="[0-9]*" value="${v}">
        <button class="minus-btn">−</button>
      </div>
    `;
    div.querySelector("input").oninput = e => {
      state.modning[i] = Number(e.target.value) || 0;
      save();
    };
    div.querySelector("button").onclick = () => removeModning(i);
    c.appendChild(div);
  });
}

["sterileInput","lph","machines"].forEach(id => {
  document.getElementById(id).oninput = e => {
    state[id === "sterileInput" ? "sterile" : id] = Number(e.target.value) || 0;
    save();
  };
});

function resetAll() {
  localStorage.removeItem("tappingState");
  state = { sterile:0, modning:[], lph:0, machines:0, activeModning:0, lastTime:Date.now() };
  document.querySelectorAll("input").forEach(i => i.value = "");
  renderInputs();
  renderTanks();
  updateTime();
}

function updateTime() {
  const rate = state.lph * state.machines;
  const total = state.sterile + state.modning.reduce((a,b)=>a+b,0);
  const hours = rate > 0 ? Math.ceil(total / rate) : 0;
  document.getElementById("timeResult").textContent = `ca. ${hours} timer`;
}

function renderTanks() {
  const a = document.getElementById("tankArea");
  a.innerHTML = "";

  const tanks = [
    { label: "Steriltank", liters: state.sterile },
    ...state.modning.map(l => ({ label:"Modningstank", liters:l }))
  ];

  tanks.forEach(t => {
    const tank = document.createElement("div");
    tank.className = "tank";

    const fill = document.createElement("div");
    fill.className = "fill";
    fill.style.height = t.liters > 0 ? "100%" : "0%";

    const label = document.createElement("div");
    label.className = "tank-label";
    label.textContent = t.label;

    const lit = document.createElement("div");
    lit.className = "tank-liters";
    lit.textContent = Math.round(t.liters) + " L";

    tank.appendChild(fill);
    tank.appendChild(label);
    tank.appendChild(lit);
    a.appendChild(tank);
  });
}

function tick() {
  const now = Date.now();
  const dt = (now - state.lastTime) / 3600000;
  state.lastTime = now;

  const rate = state.lph * state.machines;
  if (rate <= 0) return;

  if (state.modning.length > 0) {
    const i = state.activeModning;
    state.modning[i] = Math.max(0, state.modning[i] - rate * dt);
    if (state.modning[i] === 0) state.activeModning++;
  } else if (state.sterile > 0) {
    state.sterile = Math.max(0, state.sterile - rate * dt);
  }

  updateTime();
  renderTanks();
  save();
}

load();
renderInputs();
renderTanks();
updateTime();
setInterval(tick, 1000);
</script>

</body>
</html>
