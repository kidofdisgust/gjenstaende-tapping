<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gjenstående Tapping</title>

<style>
body {
  margin: 0;
  padding: 16px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f6f7;
  color: #222;
}

h1 {
  margin-top: 0;
  font-size: 22px;
}

.section {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

label {
  font-size: 14px;
  margin-bottom: 4px;
  display: block;
}

.input-row {
  display: flex;
  gap: 6px;
  align-items: center;
}

input {
  flex: 1;
  padding: 10px;
  font-size: 18px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.minus-btn {
  width: 42px;
  height: 42px;
  font-size: 24px;
  border-radius: 8px;
  border: none;
  background: #ddd;
  cursor: pointer;
}

.add-btn {
  width: 100%;
  margin-top: 10px;
  padding: 10px;
  font-size: 20px;
  border-radius: 10px;
  border: none;
  background: #e0e0e0;
  cursor: pointer;
}

.result {
  font-size: 32px;
  font-weight: bold;
  text-align: center;
}

.reset-btn {
  margin-top: 10px;
  width: 100%;
  padding: 12px;
  font-size: 18px;
  border-radius: 10px;
  border: none;
  background: #d9534f;
  color: #fff;
  cursor: pointer;
}

.tank-area {
  display: flex;
  gap: 10px;
  height: 220px;
}

.tank {
  flex: 1;
  border: 2px solid #888;
  border-radius: 12px;
  position: relative;
  background: #fff;
  overflow: hidden;
}

.fill {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: linear-gradient(#4caf50, #81c784);
  transition: height 0.5s linear;
}

.tank-label {
  position: absolute;
  top: 6px;
  width: 100%;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
}

.tank-liters {
  position: absolute;
  bottom: 6px;
  width: 100%;
  text-align: center;
  font-size: 14px;
}
</style>
</head>

<body>

<h1>Gjenstående Tapping</h1>

<div class="section">
  <label>Steriltank (liter)</label>
  <input id="sterileInput">

  <button class="add-btn" onclick="addModning()">＋ Legg til Modningstank</button>

  <div id="modningInputs"></div>

  <label>Liter per time (per maskin)</label>
  <input id="lph">

  <label>Antall maskiner</label>
  <input id="machines">
</div>

<div class="section">
  <div class="result" id="timeResult">ca. 0 timer</div>
  <button class="reset-btn" onclick="resetAll()">Nullstill</button>
</div>

<div class="section">
  <div class="tank-area" id="tankArea"></div>
</div>

<script>
let state = {
  sterile: 0,
  modning: [],
  lph: 0,
  machines: 0,
  activeModning: 0,
  lastTime: Date.now()
};

const MAX_TANKS = 5;

function save() {
  localStorage.setItem("tappingState", JSON.stringify(state));
}

function load() {
  const s = localStorage.getItem("tappingState");
  if (s) state = JSON.parse(s);
}

function addModning() {
  if (state.modning.length >= MAX_TANKS - 1) return;
  state.modning.push(0);
  save();
  renderInputs();
  setTimeout(() => {
    document.querySelectorAll(".modning-input").slice(-1)[0]?.focus();
  }, 50);
}

function removeModning(i) {
  state.modning.splice(i, 1);
  if (state.activeModning > i) state.activeModning--;
  save();
  renderInputs();
}

function renderInputs() {
  const c = document.getElementById("modningInputs");
  c.innerHTML = "";
  state.modning.forEach((v, i) => {
    const div = document.createElement("div");
    div.innerHTML = `
      <label>Modningstank ${i + 1} (liter)</label>
      <div class="input-row">
        <input class="modning-input" value="${v}">
        <button class="minus-btn">−</button>
      </div>
    `;
    div.querySelector("input").oninput = e => {
      state.modning[i] = Number(e.target.value) || 0;
      save();
    };
    div.querySelector("button").onclick = () => removeModning(i);
    c.appendChild(div);
  });
}

["sterileInput","lph","machines"].forEach(id => {
  document.getElementById(id).oninput = e => {
    state[id === "sterileInput" ? "sterile" : id] = Number(e.target.value) || 0;
    save();
  };
});

function resetAll() {
  localStorage.removeItem("tappingState");
  state = { sterile:0, modning:[], lph:0, machines:0, activeModning:0, lastTime:Date.now() };
  document.querySelectorAll("input").forEach(i => i.value = "");
  renderInputs();
  renderTanks();
  updateTime();
}

function updateTime() {
  const rate = state.lph * state.machines;
  const total = state.sterile + state.modning.reduce((a,b)=>a+b,0);
  const hours = rate > 0 ? Math.ceil(total / rate) : 0;
  document.getElementById("timeResult").textContent = `ca. ${hours} timer`;
}

function renderTanks() {
  const a = document.getElementById("tankArea");
  a.innerHTML = "";
  const tanks = [...state.modning, state.sterile];

  tanks.forEach((l, i) => {
    const t = document.createElement("div");
    t.className = "tank";
    const f = document.createElement("div");
    f.className = "fill";
    f.style.height = Math.max(0, Math.min(100, (l / Math.max(l,1)) * 100)) + "%";
    const label = document.createElement("div");
    label.className = "tank-label";
    label.textContent = i < state.modning.length ? `Modningstank ${i+1}` : "Steriltank";
    const lit = document.createElement("div");
    lit.className = "tank-liters";
    lit.textContent = Math.round(l) + " L";
    t.appendChild(f);
    t.appendChild(label);
    t.appendChild(lit);
    a.appendChild(t);
  });
}

function tick() {
  const now = Date.now();
  const dt = (now - state.lastTime) / 3600000;
  state.lastTime = now;

  const rate = state.lph * state.machines;
  if (rate <= 0) return;

  if (state.modning.length > 0) {
    const i = state.activeModning;
    if (state.modning[i] > 0) {
      const d = Math.min(rate * dt, state.modning[i]);
      state.modning[i] -= d;
      state.sterile += d;
    } else {
      state.activeModning = Math.min(i + 1, state.modning.length - 1);
    }
  } else if (state.sterile > 0) {
    state.sterile = Math.max(0, state.sterile - rate * dt);
  }

  updateTime();
  renderTanks();
  save();
}

load();
renderInputs();
renderTanks();
updateTime();
setInterval(tick, 1000);
</script>

</body>
</html>
