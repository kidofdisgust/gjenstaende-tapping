<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gjenstående Tapping</title>

<style>
body {
  margin: 0;
  padding: 16px;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f8fafc;
}

h1 {
  text-align: center;
  margin-bottom: 10px;
}

.card {
  background: white;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
  border: 1px solid #e5e7eb;
}

label {
  display: block;
  margin-top: 10px;
  font-size: 14px;
}

input {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #cbd5f5;
  margin-top: 4px;
}

button {
  padding: 10px 14px;
  font-size: 18px;
  border-radius: 10px;
  border: none;
  background: #e5e7eb;
  margin-top: 8px;
}

.reset {
  background: #ef4444;
  color: white;
  width: 100%;
}

.tanks {
  display: flex;
  gap: 14px;
  overflow-x: auto;
}

.tank-wrap {
  width: 110px;
  text-align: center;
}

.tank {
  height: 220px;
  border-radius: 14px;
  border: 2px solid #94a3b8;
  background: #f1f5f9;
  overflow: hidden;
  position: relative;
}

.fill {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: linear-gradient(to top, #22c55e, #4ade80);
  transform-origin: bottom;
}

.small {
  font-size: 13px;
}

.time {
  text-align: center;
  font-size: 22px;
  font-weight: 600;
}
</style>
</head>

<body>

<h1>Gjenstående Tapping</h1>

<div class="card">
  <label>Steriltank (liter)</label>
  <input id="sterilInput">

  <div id="modningInputs"></div>

  <button id="addTank">+ Legg til Modningstank</button>

  <label>Liter per time (per maskin)</label>
  <input id="rateInput">

  <label>Antall maskiner</label>
  <input id="machineInput">
</div>

<div class="card">
  <div class="time" id="timeLeft">ca. – timer</div>
</div>

<div class="card">
  <div class="tanks" id="tankView"></div>
</div>

<div class="card">
  <button class="reset" id="reset">Nullstill</button>
</div>

<script>
let state = JSON.parse(localStorage.getItem("state")) || {
  steril: { max: 0, current: 0 },
  modning: [],
  rate: 0,
  machines: 0,
  last: performance.now()
};

function save() {
  localStorage.setItem("state", JSON.stringify(state));
}

const modningInputs = document.getElementById("modningInputs");
const tankView = document.getElementById("tankView");
const timeLeftEl = document.getElementById("timeLeft");

function rebuildInputs() {
  modningInputs.innerHTML = "";
  state.modning.forEach((tank, i) => {
    const label = document.createElement("label");
    label.textContent = `Modningstank ${i + 1} (liter)`;

    const input = document.createElement("input");
    input.value = tank.max || "";
    input.oninput = () => {
      tank.max = tank.current = Number(input.value);
      save();
    };

    const remove = document.createElement("button");
    remove.textContent = "− Fjern";
    remove.onclick = () => {
      state.modning.splice(i, 1);
      rebuildInputs();
      save();
    };

    modningInputs.append(label, input, remove);
  });
}

function rebuildTanks() {
  tankView.innerHTML = "";

  const all = [
    { label: "Steriltank", tank: state.steril },
    ...state.modning.map((t, i) => ({ label: `Modning ${i + 1}`, tank: t }))
  ];

  state.views = [];

  all.forEach(obj => {
    const wrap = document.createElement("div");
    wrap.className = "tank-wrap";

    const tank = document.createElement("div");
    tank.className = "tank";

    const fill = document.createElement("div");
    fill.className = "fill";
    tank.appendChild(fill);

    const label = document.createElement("div");
    label.textContent = obj.label;
    label.className = "small";

    const val = document.createElement("div");
    val.className = "small";

    wrap.append(tank, label, val);
    tankView.appendChild(wrap);

    state.views.push({ tank: obj.tank, fill, val });
  });
}

sterilInput.value = state.steril.max || "";
rateInput.value = state.rate || "";
machineInput.value = state.machines || "";

sterilInput.oninput = () => {
  state.steril.max = state.steril.current = Number(sterilInput.value);
  save();
};

rateInput.oninput = () => { state.rate = Number(rateInput.value); save(); };
machineInput.oninput = () => { state.machines = Number(machineInput.value); save(); };

addTank.onclick = () => {
  state.modning.push({ max: 0, current: 0 });
  rebuildInputs();
  save();
};

reset.onclick = () => {
  localStorage.clear();
  location.reload();
};

rebuildInputs();
rebuildTanks();

function loop(t) {
  const dt = (t - state.last) / 1000;
  state.last = t;

  const speed = state.rate * state.machines;

  if (speed > 0) {
    const delta = speed * dt / 3600;

    // Tapp fra Steriltank
    state.steril.current -= delta;

    // Hvis Steriltank går tom, hent fra Modningstanker
    while (state.steril.current < 0 && state.modning.length > 0) {
      const needed = Math.abs(state.steril.current);
      const m = state.modning[0];

      m.current -= needed;

      if (m.current <= 0) {
        state.modning.shift();
        state.steril.current = 0;
      } else {
        state.steril.current = 0;
      }
    }

    if (state.steril.current < 0) state.steril.current = 0;

    save();
  }

  // Oppdater tanker visuelt
  state.views.forEach(v => {
    v.fill.style.height =
      v.tank.max ? (v.tank.current / v.tank.max * 100) + "%" : "0%";
    v.val.textContent = Math.round(v.tank.current) + " L";
  });

  // Beregn ca. timer igjen
  const totalLiters =
    state.steril.current +
    state.modning.reduce((s, t) => s + t.current, 0);

  if (speed > 0 && totalLiters > 0) {
    const hours = Math.ceil(totalLiters / speed);
    timeLeftEl.textContent = `ca. ${hours} timer`;
  } else {
    timeLeftEl.textContent = "ca. – timer";
  }

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>

</body>
</html>
